MOLINFO STRUCTURE=ref.pdb

WHOLEMOLECULES ENTITY0=1-3261 ENTITY1=3262
FIT_TO_TEMPLATE REFERENCE=backbone.pdb TYPE=OPTIMAL

# Group definition
ref: GROUP NDX_FILE=index.ndx NDX_GROUP=C-alpha
site: GROUP NDX_FILE=index.ndx NDX_GROUP=pocket_noh  
Oxygens: GROUP NDX_FILE=index.ndx NDX_GROUP=Oxygens
Ca_EF2: GROUP NDX_FILE=index.ndx NDX_GROUP=Ca_EF2
Oxygens_EF3: GROUP NDX_FILE=index.ndx NDX_GROUP=Oxygens_EF3
Ca_EF3: GROUP NDX_FILE=index.ndx NDX_GROUP=Ca_EF3

WRAPAROUND ATOMS=Ca_EF2 AROUND=site

ref_center: COM ATOMS=ref
Ox_center: COM ATOMS=Oxygens
site_center: COM ATOMS=site
Ca_center: COM ATOMS=Ca_EF2

ref_coord: POSITION ATOM=ref_center NOPBC
Ox_coord: POSITION ATOM=Ox_center NOPBC
site_coord: POSITION ATOM=site_center NOPBC
Ca_coord: POSITION ATOM=Ca_center NOPBC


# Distances with the Oxygens 
Ox_dx: MATHEVAL ARG=Ca_coord.x,Ox_coord.x FUNC=x-y PERIODIC=NO
Ox_dy: MATHEVAL ARG=Ca_coord.y,Ox_coord.y FUNC=x-y PERIODIC=NO
Ox_dz: MATHEVAL ARG=Ca_coord.z,Ox_coord.z FUNC=x-y PERIODIC=NO
Ox_rho: MATHEVAL ARG=Ox_dx,Ox_dy,Ox_dz FUNC=sqrt(x*x+y*y+z*z) PERIODIC=NO
Ox_theta: MATHEVAL ARG=Ox_dz,Ox_rho FUNC=acos(x/y) PERIODIC=0.,pi
Ox_phi: MATHEVAL ARG=Ox_dx,Ox_dy FUNC=atan2(y,x) PERIODIC=-pi,pi


CM_dx: MATHEVAL ARG=Ca_coord.x,ref_coord.x FUNC=x-y PERIODIC=NO
CM_dy: MATHEVAL ARG=Ca_coord.y,ref_coord.y FUNC=x-y PERIODIC=NO
CM_dz: MATHEVAL ARG=Ca_coord.z,ref_coord.z FUNC=x-y PERIODIC=NO
CM_rho: MATHEVAL ARG=CM_dx,CM_dy,CM_dz FUNC=sqrt(x*x+y*y+z*z) PERIODIC=NO
CM_theta: MATHEVAL ARG=CM_dz,CM_rho FUNC=acos(x/y) PERIODIC=0.,pi
CM_phi: MATHEVAL ARG=CM_dx,CM_dy FUNC=atan2(y,x) PERIODIC=-pi,pi

rmsd: RMSD REFERENCE=backbone.pdb TYPE=OPTIMAL

# Restraining potential of the section of sphere
restr_rho: UPPER_WALLS ARG=CM_rho AT=4.5 KAPPA=20000 OFFSET=0

# Coordination numbers
CN_whole: COORDINATION GROUPA=Ca_EF2 GROUPB=ref R_0=0.45
CN_site: COORDINATION GROUPA=Ca_EF2 GROUPB=site R_0=0.45

# Compute the projections of Ca2+ on the axis defined by the CM and the Oxygens
CM_Ox_dx: MATHEVAL ARG=ref_coord.x,Ox_coord.x FUNC=x-y PERIODIC=NO
CM_Ox_dy: MATHEVAL ARG=ref_coord.y,Ox_coord.y FUNC=x-y PERIODIC=NO
CM_Ox_dz: MATHEVAL ARG=ref_coord.z,Ox_coord.z FUNC=x-y PERIODIC=NO
d: MATHEVAL ARG=CM_Ox_dx,CM_Ox_dy,CM_Ox_dz FUNC=sqrt(x*x+y*y+z*z) PERIODIC=NO
a: MATHEVAL ARG=CM_dy,Ox_dz,CM_dz,Ox_dy VAR=x,y,z,w FUNC=x*y-z*w PERIODIC=NO
b: MATHEVAL ARG=CM_dz,Ox_dx,CM_dx,Ox_dz VAR=x,y,z,w FUNC=x*y-z*w PERIODIC=NO 
c: MATHEVAL ARG=CM_dx,Ox_dy,CM_dy,Ox_dx VAR=x,y,z,w FUNC=x*y-z*w PERIODIC=NO
h: MATHEVAL ARG=a,b,c,d VAR=x,y,z,w FUNC=(x*x+y*y+z*z)/(w*w) PERIODIC=NO
proj: MATHEVAL ARG=d,Ox_rho,h FUNC=x+sqrt(y*y-z*z) PERIODIC=NO

# Metadynamics
METAD ...
ARG=CM_rho,CM_theta,CM_phi
GRID_MIN=0.,0.,-pi
GRID_MAX=7.0,pi,pi
SIGMA=0.01,pi/32.,pi/16.
HEIGHT=1.2
PACE=500 #MD steps, every 1 ps
BIASFACTOR=10
TEMP=310
LABEL=metad
CALC_RCT
... METAD


# Position of Ca2+ in EF3
Ox_center_EF3: COM ATOMS=Oxygens_EF3
Ca_center_EF3: COM ATOMS=Ca_EF3
Ca_coord_EF3: POSITION ATOM=Ca_center_EF3 NOPBC
Ox_coord_EF3: POSITION ATOM=Ox_center_EF3 NOPBC

Ox_dx_EF3: MATHEVAL ARG=Ca_coord_EF3.x,Ox_coord_EF3.x FUNC=x-y PERIODIC=NO
Ox_dy_EF3: MATHEVAL ARG=Ca_coord_EF3.y,Ox_coord_EF3.y FUNC=x-y PERIODIC=NO
Ox_dz_EF3: MATHEVAL ARG=Ca_coord_EF3.z,Ox_coord_EF3.z FUNC=x-y PERIODIC=NO
Ox_rho_EF3: MATHEVAL ARG=Ox_dx_EF3,Ox_dy_EF3,Ox_dz_EF3 FUNC=sqrt(x*x+y*y+z*z) PERIODIC=NO


PRINT ARG=metad.* FILE=metad_data.dat STRIDE=500
PRINT ARG=restr_rho.* FILE=sphere_restraint.dat STRIDE=500
PRINT ARG=ref_coord.x,ref_coord.y,ref_coord.z FILE=ref_coord.dat STRIDE=500
PRINT ARG=Ox_coord.x,Ox_coord.y,Ox_coord.z FILE=Ox_coord.dat STRIDE=500
PRINT ARG=Ca_coord.x,Ca_coord.y,Ca_coord.z FILE=Ca_EF2_coord.dat STRIDE=500
PRINT ARG=Ca_coord_EF3.x,Ca_coord_EF3.y,Ca_coord_EF3.z,Ox_rho_EF3 FILE=Ca_EF3_coord.dat STRIDE=500
PRINT ARG=Ox_rho,Ox_theta,Ox_phi FILE=rtp_coord.dat STRIDE=500
PRINT ARG=h,proj FILE=Ca_proj.dat STRIDE=500
PRINT ARG=CN_whole,CN_site FILE=all_coordination_45.dat STRIDE=500
PRINT ARG=rmsd FILE=rmsd.dat STRIDE=500

DUMPMASSCHARGE FILE=mcfile

FLUSH STRIDE=500
