WHOLEMOLECULES ENTITY0=1-3261 ENTITY1=3262

# Group definition (from index.ndx)
ref: GROUP NDX_FILE=index.ndx NDX_GROUP=C-alpha
site: GROUP NDX_FILE=index.ndx NDX_GROUP=pocket_noh  
Oxygens: GROUP NDX_FILE=index.ndx NDX_GROUP=Oxygens
Ca_EF2: GROUP NDX_FILE=index.ndx NDX_GROUP=Ca_EF2
Oxygens_EF3: GROUP NDX_FILE=index.ndx NDX_GROUP=Oxygens_EF3
Ca_EF3: GROUP NDX_FILE=index.ndx NDX_GROUP=Ca_EF3


# Definition of the funnel position (fps)
fps: FUNNEL_PS ...
   LIGAND=Ca_EF2
   REFERENCE=pocket_backbone.pdb 
   ANCHOR=1196
   POINTS=4.58,4.696,3.839,4.023,5.239,3.773
...

# Definition of the funnel restraint
funnel: FUNNEL ...
   ARG=fps.lp,fps.ld 
   ZCC=2.5
   ALPHA=0.45 
   RCYL=0.2 
   MINS=0.0 
   MAXS=5.5 
   KAPPA=30000  
   NBINS=500 
   NBINZ=500
   FILE=BIAS 
...


# Definition of the CM of each group
ref_center: COM ATOMS=ref
Ox_center: COM ATOMS=Oxygens
site_center: COM ATOMS=site
Ca_center: COM ATOMS=Ca_EF2

# Distance of Ca_EF3 with the Oxygens and the CM
Ox_rho: DISTANCE ATOMS=Ox_center,Ca_center
CM_rho: DISTANCE ATOMS=ref_center,Ca_center

# Definition of the coordinate of the CM of each group 
ref_coord: POSITION ATOM=ref_center
Ox_coord: POSITION ATOM=Ox_center
site_coord: POSITION ATOM=site_center
Ca_coord: POSITION ATOM=Ca_center

# Compute the projections of Ca2+ (in EF2) on the axis defined by the CM and the Oxygens
CM_Ox_EF2: DISTANCE ATOMS=Ox_center,ref_center
Ox_rho_c: DISTANCE ATOMS=Ox_center,Ca_center COMPONENTS
CM_rho_c: DISTANCE ATOMS=ref_center,Ca_center COMPONENTS
a: MATHEVAL ARG=CM_rho_c.y,Ox_rho_c.z,CM_rho_c.z,Ox_rho_c.y VAR=x,y,z,w FUNC=x*y-z*w PERIODIC=NO
b: MATHEVAL ARG=CM_rho_c.z,Ox_rho_c.x,CM_rho_c.x,Ox_rho_c.z VAR=x,y,z,w FUNC=x*y-z*w PERIODIC=NO 
c: MATHEVAL ARG=CM_rho_c.x,Ox_rho_c.y,CM_rho_c.y,Ox_rho_c.x VAR=x,y,z,w FUNC=x*y-z*w PERIODIC=NO
h: MATHEVAL ARG=a,b,c,CM_Ox_EF3 VAR=x,y,z,w FUNC=(x*x+y*y+z*z)/(w*w) PERIODIC=NO
proj: MATHEVAL ARG=CM_Ox_EF2,Ox_rho,h FUNC=x+sqrt(y*y-z*z) PERIODIC=NO


# Compute the radius of gyration of the protein
Rg_pocket: GYRATION TYPE=RADIUS ATOMS=site
Rg: GYRATION TYPE=RADIUS ATOMS=ref

# Compute the RMSD of the pocket & C_alpha in the protein 
rmsd_pocket: RMSD REFERENCE=pocket_backbone.pdb TYPE=OPTIMAL
rmsd: RMSD REFERENCE=C_alpha.pdb TYPE=OPTIMAL

# Restraint on the rmsd
uwall_rmsd: UPPER_WALLS ...
   ARG=rmsd 
   AT=0.12 
   KAPPA=500000 
   EXP=2 
   OFFSET=0 
...


# Restraint the position of the ligand inside the funnel
lwall: LOWER_WALLS ...
   ARG=fps.lp 
   AT=0.1 
   KAPPA=40000 
   EXP=2 
   OFFSET=0
...


uwall: UPPER_WALLS ...
   ARG=fps.lp 
   AT=5.0 
   KAPPA=40000 
   EXP=2 
   OFFSET=0
... 


# Restraining potential of the section of sphere
restr_rho: UPPER_WALLS ...
    ARG=Ox_rho 
    AT=4.0 
    KAPPA=20000 
    OFFSET=0
...


# Define the multiple walkers metadynamics
metad: METAD ... 
   ARG=Ox_rho
   PACE=500 

   # These parameters change in the four simulations
   HEIGHT=1.2 
   BIASFACTOR=20  

   # From unbiased simulation (in nm)
   SIGMA=0.007 

   # Use a "large" grid
   GRID_MIN=0 
   GRID_MAX=6.0

   # call the MPI walkers 
   WALKERS_MPI

   # I have 2 subfolders in the working directory
   WALKERS_DIR=../

   # Recover the c(t) for reweighting
   CALC_RCT
...


# Coordination numbers for the Ca2+ in EF2
CN_whole: COORDINATION GROUPA=Ca_EF2 GROUPB=ref R_0=0.45
CN_site: COORDINATION GROUPA=Ca_EF2 GROUPB=site R_0=0.45


# Position of Ca2+ in EF3
Ox_center_EF3: COM ATOMS=Oxygens_EF3
Ca_center_EF3: COM ATOMS=Ca_EF3
Ca_coord_EF3: POSITION ATOM=Ca_center_EF3
Ox_coord_EF3: POSITION ATOM=Ox_center_EF3
Ox_rho_EF3: DISTANCE ATOMS=Ox_center_EF3,Ca_center_EF3
Ox_rho_EF3_c: DISTANCE ATOMS=Ox_center_EF3,Ca_center_EF3 COMPONENTS

PRINT ARG=metad.* FILE=metad_data.dat STRIDE=500
PRINT ARG=Ox_rho_EF3_c.*,Ox_rho_c.* FILE=components.dat STRIDE=500
PRINT ARG=Rg,Rg_pocket FILE=gyration.dat STRIDE=500
PRINT ARG=ref_coord.* FILE=ref_coord.dat STRIDE=500
PRINT ARG=Ox_coord.* FILE=Ox_coord.dat STRIDE=500
PRINT ARG=Ca_coord.* FILE=Ca_EF2_coord.dat STRIDE=500
PRINT ARG=Ca_coord_EF3.*,Ox_rho_EF3 FILE=Ca_EF3_coord.dat STRIDE=500
PRINT ARG=h,proj FILE=Ca_proj.dat STRIDE=500
PRINT ARG=CN_whole,CN_site FILE=all_coordination_45.dat STRIDE=500
PRINT ARG=rmsd,rmsd_pocket FILE=rmsd.dat STRIDE=500
PRINT ARG=fps.*,funnel.* FILE=Ca_EF2_funnel.dat STRIDE=500
PRINT ARG=lwall.*,uwall.*,restr_rho.*,uwall_rmsd.* FILE=walls.dat STRIDE=500


DUMPMASSCHARGE FILE=mcfile

FLUSH STRIDE=500
